/* REQUIRED HEADERS */
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/pinctrl/stm32-pinfunc.h>

/ {
    /* =====================================================================
     * USB VBUS REGULATORS
     * =====================================================================
     * Drivers for the STMPS2252 Power Switch.
     */

    /* USB1 (OTG Port) VBUS */
    vbus_sw_usb1: regulator-vbus-usb1 {
        compatible = "regulator-fixed";
        regulator-name = "vbus_usb1";
        regulator-min-microvolt = <5000000>;
        regulator-max-microvolt = <5000000>;
        
        /* PH10 -> STMPS2252 EN1 (Active High) */
        gpio = <&gpioh 10 GPIO_ACTIVE_HIGH>; 
        enable-active-high;
        
        pinctrl-names = "default";
        pinctrl-0 = <&usb1_vbus_pins_mx>; 
    };

    /* USB2 (Host Port) VBUS */
    vbus_sw_usb2: regulator-vbus-usb2 {
        compatible = "regulator-fixed";
        regulator-name = "vbus_usb2";
        regulator-min-microvolt = <5000000>;
        regulator-max-microvolt = <5000000>;
        
        /* PH11 -> STMPS2252 EN2 (Active High) */
        gpio = <&gpioh 11 GPIO_ACTIVE_HIGH>; 
        enable-active-high;
        
        pinctrl-names = "default";
        pinctrl-0 = <&usb2_vbus_pins_mx>;
    };
};

&pinctrl {
    /* =====================================================================
     * PIN CONFIGURATION
     * =====================================================================
     */

    /* USB1 Power Control */
    usb1_vbus_pins_mx: usb1-vbus-pins-mx-0 {
        pins-en {
            pinmux = <STM32_PINMUX('H', 10, GPIO)>;
            bias-disable;
            drive-push-pull;
            output-low; /* Default OFF */
        };
        pins-oc {
            pinmux = <STM32_PINMUX('H', 14, GPIO)>;
            /* External Pull-Up (R175) present on PCB. Keep High-Z. */
            bias-disable; 
        };
    };

    /* USB2 Power Control */
    usb2_vbus_pins_mx: usb2-vbus-pins-mx-0 {
        pins-en {
            pinmux = <STM32_PINMUX('H', 11, GPIO)>;
            bias-disable;
            drive-push-pull;
            output-low; /* Default OFF */
        };
        pins-oc {
            pinmux = <STM32_PINMUX('H', 15, GPIO)>;
            /* External Pull-Up (R174) present on PCB. Keep High-Z. */
            bias-disable; 
        };
    };
};

/* =====================================================================
 * USB CONTROLLERS
 * =====================================================================
 */

/* USB1: OTG Controller -> Type-A Host */
&usbotg_hs {
    status = "okay";
    
    /* NO PINCTRL: Data pins are dedicated. ID pin is unconnected. */
    
    vbus-supply = <&vbus_sw_usb1>;
    
    /* Force HOST mode (ignores missing ID pin) */
    dr_mode = "host"; 
    
    phys = <&usbphyc_port1 0>;
    phy-names = "usb2-phy";
};

/* USB2: EHCI Host Controller */
&usbh_ehci {
    status = "okay";
    
    /* NO PINCTRL: Data pins are dedicated. */
    
    vbus-supply = <&vbus_sw_usb2>;
    
    phys = <&usbphyc_port0>;
    phy-names = "usb";
};

/* USB2 Companion: OHCI (USB 1.1) */
&usbh_ohci {
    status = "okay";
    phys = <&usbphyc_port0>;
    phy-names = "usb";
    vbus-supply = <&vbus_sw_usb2>;
};

/* =====================================================================
 * PHY TUNING (Critical for ECMF02 Filter)
 * =====================================================================
 */

&usbphyc {
    status = "okay";
    vdd3v3-supply = <&vdd_usb>; 
};

&usbphyc_port0 {
    status = "okay";
    st,tune-hs-dc-level = <2>;
    st,enable-hs-rtime-reduction;
    st,trim-fine-tune = <3>;
    st,current-boost-microamp = <1000>; 
};

&usbphyc_port1 {
    status = "okay";
    st,tune-hs-dc-level = <2>;
    st,enable-hs-rtime-reduction;
    st,trim-fine-tune = <3>;
    st,current-boost-microamp = <1000>;
};
