NorStart=@NOR_START@
NorBytesToWrite=@NOR_BYTES_TO_WRITE@

# Helper to safely calculate blocks (rounds up to ensure no truncation)
calc_blks=setexpr blkcnt ${filesize} + 0x1ff; setexpr blkcnt ${blkcnt} / 0x200

# 1. Flash SPI-NOR (Exactly as original)
updateSPINor=echo Flashing image from SDCard to NOR...; sf probe; sf erase ${NorStart} ${NorBytesToWrite}; fatload mmc ${envpart} ${loadaddr} nor-image.img; sf write ${loadaddr} ${NorStart} ${NorBytesToWrite}

# 2. Flash TF-A to eMMC Boot0 (Hardware Partition 1)
# Note: Ensure the filename here matches what genimage copies to the vfat partition
updateEmmcBoot0=echo Flashing TF-A to eMMC Boot0...; mmc dev 1 1; fatload mmc ${envpart} ${loadaddr} tf-a-sdcard.stm32; run calc_blks; mmc erase 0x0 ${blkcnt}; mmc write ${loadaddr} 0x0 ${blkcnt}

# 3. Flash eMMC User Area (Hardware Partition 0) with 1GB Full Erase
updateEmmcUser=echo Erasing entire 1GB eMMC...; mmc dev 1 0; mmc erase 0x0 0x200000; echo Loading eMMC Image...; fatload mmc ${envpart} ${loadaddr} emmc.img; run calc_blks; echo Writing new image...; mmc write ${loadaddr} 0x0 ${blkcnt}

# Main Execution Sequence
flashCmd=run updateSPINor; run updateEmmcBoot0; run updateEmmcUser; echo PLEASE POWER DOWN, EJECT SDCARD, AND POWER BACK UP TO BOOT FROM ONBOARD FLASH!!; sleep 99999;

# Entry Point
uenvcmd=run flashCmd;
