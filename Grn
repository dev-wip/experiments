# create_data_ext4.inc

# Default size in MB (can be overridden in the main recipe)
DATA_PART_SIZE ?= "120"
DATA_PART_NAME ?= "data.ext4"

# We need mkfs.ext4 from the build host tools
DEPENDS += "e2fsprogs-native"

# 1. Define the task to create the image
do_create_data_partition() {
    # path to the output file in the working directory
    IMG_PATH="${WORKDIR}/${DATA_PART_NAME}"

    # Create a blank file filled with zeros
    # bs=1M count=120 creates a 120MB file
    dd if=/dev/zero of=${IMG_PATH} bs=1M count=${DATA_PART_SIZE}

    # Format it as ext4
    # -F: Force execution
    # -L: Label the partition "DATA"
    mkfs.ext4 -F -L "DATA" ${IMG_PATH}
}

# 2. Schedule the task
# It must run before deploy so we can copy the result
addtask create_data_partition after do_compile before do_deploy

# 3. Deploy the file to the deployment directory
# This ensures genimage can find it in ${DEPLOYDIR}
do_deploy:append() {
    install -m 0644 ${WORKDIR}/${DATA_PART_NAME} ${DEPLOYDIR}/
}





# inside your main recipe file

# Define a variable (default to "0" for off)
ENABLE_DATA_PARTITION ?= "0"

# Conditionally require the file if the variable is "1"
require ${@'create_data_ext4.inc' if d.getVar('ENABLE_DATA_PARTITION') == '1' else ''}
