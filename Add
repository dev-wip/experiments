# --- Configuration ---
# Your TF-A file for eMMC (Make sure it is the EMMC version!)
tfa_image=tf-a-emmc.stm32

# 256KB = 512 blocks = 0x200 hex
tfa_write_size=0x200

# --- Functions ---

# 1. Load Image from SD Card
getTfaImage=fatload mmc 0:3 ${loadaddr} ${tfa_image}

# 2. Flash Sequence (The User's Fix)
# Step A: Configure eMMC to ENABLE writing to Boot Partition 1 (Access=1)
#         Also sets Boot=1 (Boot from here) and Ack=1.
enableBootWrite=mmc partconf 1 1 1 1

# Step B: Select the device (eMMC = 1)
selectDev=mmc dev 1

# Step C: Write the image to Block 0 of the now-exposed Boot Partition
writeTfa=mmc write ${loadaddr} 0 ${tfa_write_size}

# Step D: RESTORE Access to User Area (Access=0)
#         CRITICAL: If you skip this, Linux cannot find the RootFS!
restoreUserAccess=mmc partconf 1 1 1 0

# --- Main Command ---
# Runs the steps in exact order
installCmd=echo "--- Loading Image ---"; run getTfaImage; echo "--- Enabling Boot Access ---"; run enableBootWrite; run selectDev; echo "--- Flashing ---"; run writeTfa; echo "--- Restoring User Access ---"; run restoreUserAccess; echo "--- SUCCESS. Power off and switch to eMMC boot. ---"

# Trigger
uenvcmd=run installCmd
